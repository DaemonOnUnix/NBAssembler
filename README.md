#NB Assembler

Assembler and Decompiler for NVIDIA (Maxwell Pascal Volta Turing Ampere) GPUs.


## Requirements:

* Python >= 3.8
* CUDA >= 6.5 (Only requires `nvdisasm` for disassembly or testing)


## Supported NVIDIA GPUs:

Maxwell (SM50, SM52, SM53)

Pascal (SM60, SM61, SM62)

Volta (SM70, SM72)

Turing (SM75)

Ampere (SM80, SM86)


## Install

```
python setup.py install
```


## Use

```bash
# help
nbasm -h

# usage: nbasm [-h] [-V] {list,das,as,pre,pdas,test,det} ...

# Assembler and Decompiler for NVIDIA (Maxwell Pascal Volta Turing Ampere) GPUs.

# optional arguments:
# -h, --help show this help message and exit
# -V, --version Print version information on this tool.

# subcommands:
#{list,das,as,pre,pdas,test,det}
# list list cubin info
# das disassemble cubin
# as assemble asm
# dcc decompile asm to ptx
# test test assembler by disassemble and then assemble
# det detect machine code bits

# examples
nbasm list ethash.cubin
nbasm das -k Search -o ethash_search.s ethash.cubin
nbasm as -D DEBUG=True -o ethash.cubin ethash_search.s
nbasm dcc -o ethash.ptx ethash.s
```

## ASM Grammar

```assembly
# single line comment
# Other unused meta-information disassembled will be written into the comments of the file header. Ignored when compiling.
/* Multi-line comment */
.compute_75 # virtual_arch
.sm_75#arch
.global: NAME # Global variable
	.align 8
	.zero 368
	.byte 0xff, 0xff, 0xff, 0x7f
	.short 0x0412
	.word 0x00000020
	.quad 0x366803807ff7021f
.constants: NAME # User-defined constants
    .align 4
    .zero 4
.constants2: NAME # Constants generated by the compiler, generally because there are immediate values ​​in the code that cannot be stored in the instruction code
    .align 4
    .zero 4

# reference other files

# include assembly file, directly replace the content of the bit assembly file at this location
.include "source.s"

# include Python source code, the Python script will be executed first, after execution, use the content of the out_ variable in the Python upward text to replace at this position
.include "source.py"

.constants: {python expression} # The content (single line) in the middle of {} is a Python expression, calculate the result of the expression and replace it at this position
    ...

#{}Intermediate content (multiple lines) is regarded as Python code. After executing the Python code, use the content of the out_ variable in the Python upward text to replace it at this position
{
# For example, conditional include
if define1:
    out += '.include "source1.s"\n'
else:
    out += '.include "source2.s"\n'
out = '''
...
'''
}

.kernel: NAME # Kernel definition and code
	# Ordinary register alias mapping, supports single mapping and batch mapping (usage similar to array)
	.reg NAME, Rxx
	# Uniform register alias mapping
	.reg NAME, URxx-xx
	# Pred register alias mapping
	.reg NAME, Pxx
	# Uniform Pred register alias mapping
	.reg NAME, UPxx
	# Kernel parameters
	.param ordinal, NAME, SIZE_IN_BYTES
	# shared
	.shared SIZE_IN_BYTES

.L_label: #label
    # instruction: /*address*/ control code pred instruction. flag... operand, ...; /* instruction code*/ # reuse code
	/*1dd0*/ -:--:-:-:Y:8 @!P6 IMAD.SHL.U32 R2, R2, 0x2, RZ; /* 0x000fd000078e00ff000000020202e824 */ # ----
	# Control code: schedule_flag:Wait_barrier_mask:read_barrier_index:write_barrier_index:yield:stall
	# schedule_flag: The scheduling flag is only used by nbasm's scheduler. Automatic scheduling by default. Setting it to 'K' means that the control code of this instruction has been adjusted manually, and the scheduler ignores this instruction.
	# Wait_barrier_mask: Wait for the bitmap of read_barrier and write_barrier
	# read_barrier_index: Indefinite cycle instruction sets read-after-write dependency
	# write_barrier_index: Indefinite cycle instruction sets read-after-write dependency
	# yield: Yield, indicating that the current warp can be swapped out. Generally used for stall more than 4 cycles
	# stall: After this instruction is scheduled, the number of cycles that the next instruction will start to delay
```

## Related projects

[AsFermi](https://github.com/hyqneuron/asfermi), an SASS assembler for NVIDIA Fermi GPUs. By Hou Yunqing.

[KeplerAs](https://github.com/xiuxiazhang/KeplerAs), an SASS assembler for NVIDIA Kepler. By Xiuxia Zhang.

[MaxAs](https://github.com/NervanaSystems/maxas), an SASS assembler for NVIDIA Maxwell and Pascal. By Scott Gray.

[TuringAs](https://github.com/daadaada/turingas), an SASS assembler for NVIDIA Volta and Turing. By Da Yan.



This project is released under the MIT License.

-- Alvin Zhu
